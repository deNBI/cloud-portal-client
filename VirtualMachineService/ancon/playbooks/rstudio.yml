- name: Wait for automatic system updates 1
  shell: while sudo fuser /var/lib/dpkg/lock >/dev/null 2>&1; do sleep 1; done;
  when: rstudio_vars.create_only_backend == "false"

- name: Wait for automatic system updates 2
  shell: while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 1; done;
  when: rstudio_vars.create_only_backend == "false"

- name: Setup password for default user
  user:
    name: "{{ rstudio_vars.DEFAULT_USER }}"
    password: "{{ rstudio_vars.DEFAULT_PASSWORD_HASHED }}"

- name: Check if profiles file already exists
  stat:
    path: "{{ rstudio_vars.PROFILES_FILE_PATH }}"
  register: stat_profiles_file

- name: Install R role
  include_role:
    name: oefenweb.r
  when: rstudio_vars.create_only_backend == "false"

- name: Install rstudio-server role
  include_role:
    name: oefenweb.rstudio_server
  vars:
    rstudio_install: [r-base]
  when: rstudio_vars.create_only_backend == "false"

- name: Copy profiles file if not existing
  copy:
    content: "[*]\nsession-timeout-minutes=180"
    dest: "{{ rstudio_vars.PROFILES_FILE_PATH }}"
    mode: "0644"
    owner: "root"
    group: "root"
  when: stat_profiles_file.stat.exists == False

- name: Flush rstudio handlers
  meta: flush_handlers
  when: rstudio_vars.create_only_backend == "false"
