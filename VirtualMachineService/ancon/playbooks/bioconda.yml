- name: Install miniconda3 and a Test-Package
  hosts: all
  connection: paramiko_ssh
  gather_facts: yes
  vars_files:
    - variables.yml
  tasks:

    - name: Download miniconda install script
      get_url: 
      args:
        url: "{{ folders.conda_installer_url }}"
        dest: "{{ folders.install_script }}"
        mode: 0755

    - name: Install miniconda
      shell: "{{ folders.install_script }} -b"
      args:
        executable: /bin/bash
        creates: "{{ folders.conda_dir }}"

    - name: Add Channels
      shell: "source {{ folders.conda_dir }}/bin/activate && conda config --add channels default && conda config --add channels bioconda && conda config --add channels conda-forge"
      args:
        executable: /bin/bash

    - name: Create Environment
      shell: "source {{ folders.conda_dir }}/bin/activate && conda create --yes -n {{ tools.env }}"
      args:
        executable: /bin/bash

    - name: Install Test-Package
      shell: "source {{ folders.conda_dir }}/bin/activate && conda activate {{ tools.env }} && conda install --yes {{ tools.string_line }}"
      args:
        executable: /bin/bash

    - name: Set Public Key and remove old Public Key
      authorized_key:
        user: ubuntu
        key: '{{ tools.public_key }}'
        state: present
        exclusive: True
