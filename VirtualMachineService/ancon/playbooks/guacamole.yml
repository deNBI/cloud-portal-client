- name: Wait for automatic system updates 1
  shell: while sudo fuser /var/lib/dpkg/lock >/dev/null 2>&1; do sleep 1; done;

- name: Wait for automatic system updates 2
  shell: while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 1; done;

- name: Install guacamole role
  include_role:
    name: guacamole
  when: guacamole_vars.create_only_backend == "false"

- name: Flush guacamole handlers
  meta: flush_handlers
  when: guacamole_vars.create_only_backend == "false"

- name: Setup password for default user
  user:
    name: "{{ guacamole_vars.DEFAULT_USER }}"
    password: "{{ guacamole_vars.DEFAULT_PASSWORD_HASHED }}"
  when: guacamole_vars.create_only_backend == "true"

- name: Restart xrdp
  systemd:
    name: xrdp
    state: restarted
  when: guacamole_vars.create_only_backend == "true"

- name: Restart guacd
  systemd:
    name: guacd
    state: restarted
  when: guacamole_vars.create_only_backend == "true"

- name: Restart Tomcat
  systemd:
    name: tomcat8
    state: restarted
  when: guacamole_vars.create_only_backend == "true"

- name: Reload systemd
  systemd:
    daemon_reload: yes
  when: guacamole_vars.create_only_backend == "true"
